<html>

<head>
    <meta charset="utf-8">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <!-- <script src="https://rawgit.com/otalk/sdp/master/sdp.js"></script> -->
    <script src="https://webrtc.github.io/samples/src/js/third_party/graph.js"></script>
    <script src="test-assert.js"></script>
    <script src="draw-graphs.js"></script>
    <script src="js/sdp.js"></script>
    <script src="js/FileSaver.js"></script>
    <script src="js/sdp-tool.js"></script>
    <style>
        video {
            width: 480px;
        }
    </style>
</head>

<body>
    <input type="button" id="export" value="export sdp" onclick="exportSdpObjectToFile()"/>
    <div id="local">
        <h2>Local Video</h2>
    </div>
    <div id="remotes">
        <h2>Remote Videos</h2>
    </div>
    <script>

        function whiteNoiseStream(resolution) {
            let canvas = Object.assign(document.createElement("canvas"), resolution);
            let ctx = canvas.getContext('2d');
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            let p = ctx.getImageData(0, 0, canvas.width, canvas.height);
            requestAnimationFrame(function draw() {
                for (var i = 0; i < p.data.length; i++) {
                    p.data[i++] = Math.random() * 255;
                    p.data[i++] = Math.random() * 255;
                    p.data[i++] = Math.random() * 255;
                }
                ctx.putImageData(p, 0, 0);
                return requestAnimationFrame(draw);
            });
            return canvas.captureStream(60)
        }

        function titleCase(str) {
            return str.toLowerCase().split(' ').map(function(word) {
                return word.replace(word[0], word[0].toUpperCase())
            }).join(' ')
        }

        function fixedPeerComment(text) {
            return text.replace('pc1.', 'Peer A(Alice) ').replace('pc2.', 'Peer B(Bob) ')
        }


        let sdpObject = {
            offer: {},
            answer: {}
        }
        function console_log(text, sdp, type, status) {
            const desc = `${titleCase(type)} SDP: ${fixedPeerComment(text)} ${status}`
            console.log(desc)
            let obj = {
                sdp: sdp,
                text: desc
            }
            sdpObject[type][status] = obj
        }

        let exportSdpObjectToFile = function() {
            let blob = new Blob([JSON.stringify(sdpObject)], {type: "text/plain;charset=utf-8"})
            saveAs(blob, "sdp.json")
        }

        let [offer_status, answer_status] = ['modified', 'modified']
        // offer_status = 'origin'
        // answer_status = 'origin'


        const pc1 = new RTCPeerConnection({ sdpSemantics: 'unified-plan' })
        const pc2 = new RTCPeerConnection({ sdpSemantics: 'unified-plan' })
        pc1.onicecandidate = e => pc2.addIceCandidate(e.candidate)
        pc2.onicecandidate = e => pc1.addIceCandidate(e.candidate)
        pc2.ontrack = e => show(e.streams[0], true)

        const extensionsToFilter = [
            'urn:ietf:params:rtp-hdrext:sdes:mid',
            'urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id',
            'urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id',
        ]

        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
        // let promise = new Promise(() => {
        //         return whiteNoiseStream({ width: 1280, height: 720 })
        //     })
            .then((stream) => {
                let videoTrack = stream.getVideoTracks()[0]
                pc1.addTransceiver(videoTrack, {
                    streams: [stream],
                    sendEncodings: SDPTool.sendEncodings,
                })
                show(stream, false);
                return pc1.createOffer();
            })
            .then(offer => {
                console_log('pc1.createOffer', offer.sdp, 'offer', 'origin')
                let sdp = SDPTool.ModifyOffer(offer.sdp)
                if (offer_status === 'origin') {
                    sdp = offer.sdp 
                }
                console_log('pc1.setLocalDescription origin, pc2.setRemoteDescription', sdp, 'offer', offer_status)
                console.log('sdp === offer.sdp ? ', sdp === offer.sdp)
                return Promise.all([
                    pc1.setLocalDescription(offer),
                    pc2.setRemoteDescription({
                        type: 'offer',
                        sdp,
                    }),
                ]);
            })
            .then(() => pc2.createAnswer())
            .then(answer => {
                console_log('pc2.createAnswer', answer.sdp, 'answer', 'origin')
                let sdp = SDPTool.ModifyAnswer(answer.sdp)
                if (answer_status === 'origin') {
                    sdp = answer.sdp 
                }
                console_log('pc2.setLocalDescription origin, pc1.setRemoteDescription', sdp, 'answer', answer_status)
                console.log('sdp === answer.sdp ? ', sdp === answer.sdp)
                return Promise.all([
                    pc2.setLocalDescription(answer),
                    pc1.setRemoteDescription({
                        type: 'answer',
                        sdp
                    }),
                ]);
            })
            .then(() => {
                window.setInterval(() => {
                    draw(pc1, pc2);
                    // draw(pc2, pc1);
                }, 2000);
                // console.log(sdpObject)
            })
            .catch(e => console.error(e));
    </script>
</body>

</html>